---
title: "編"
subtitle: "サブタイトル"
author: "宇畑 優太（1260404）"
date: today
execute: 
  echo: true
  warning: false
  message: true
format: 
  pdf:
    fig-width: 5
    fig-height: 3
    toc: true
    toc-depth: 2
    number-sections: true
    include-in-header:
      - text: \setlength{\parindent}{1em}
pdf-engine: lualatex
documentclass: ltjsarticle 
lang: ja
---

# 準備 {-}
```{r global_option}
## PDF に出力する際は cairo を使用する
if (knitr::is_latex_output()) {
  knitr::opts_chunk$set(dev = "cairo_pdf")
}

#パッケージの読み込み
pacman::p_load(tidyverse, 
               broom, 
               coefplot, 
               texreg,
               bayesplot,
               rstan,
               rstanrm,
               parallel,
               posterior,
               cmdstanr,
               patchwork,
               ggplot2,
               tidybayes,
               ggfortify,
               gridExtra,
               forecast,
               tseries,
               summarytools
               )


#日本語の設定
if (.Platform$OS.type == "windows") { 
  if (require(fontregisterer)) {
    my_font <- "Yu Gothic"
  } else {
    my_font <- "Japan1"
  }
} else if (capabilities("aqua")) {
  my_font <- "HiraginoSans-W3"
} else {
  my_font <- "IPAexGothic"
}

theme_set(theme_gray(base_size = 9,
                     base_family = my_font))
```


```{r}
#計算の高速化
rstan_options(auto_write = TRUE) 
options(mc.cores = parallel::detectCores())
```


# 分析の対象

```{r}
front <- Seatbelts[, "front"]
```
交通事故の死傷者をモデル化する

季節性は当然あるだろう

また，ガソリンの値段や法案によって死傷者も変化するだろう


# 対数変化
```{r}
#対数系列
log_front <- log(front)

#図示
ggtsdisplay(log_front ,main = "対数系列" )
```
右下の偏自己相関でも一年単位での大きな自己相関が見られる．


# 差分系列の作成方法

```{r}
#原型列
front

#ラグをとった
stats::lag(front,-1)
```

ラグから現系列を引くこことで差分系列が手に入る

```{r}
front - stats::lag(front,-1)
```



```{r}
#対数差分系列
log_diff <- diff(log_front)

#図示

ggtsdisplay(log_diff,main = "対数差分系列")
```

差分系列は長期にわたって平均値が変化せず，単位根がないことグラフからも分かる．

# 季節成分の取り扱い

1年周期での自己相関が目立った．季節性があると言うことである．

```{r}
#1月毎の図

ggsubseriesplot(front)
```


```{r}
#季節差分をとってみる
frequency(front)


diff(front,lag = frequency(front))

```


次は対数差分系列に対して，季節性とってみる

```{r}
#対数差分にさらに季節差分をとる

seas_log_diff <- diff(log_diff,lag = frequency(log_front))

#図示

ggtsdisplay(seas_log_diff)
```

季節階差をとっても，影響を全て取り除けるわけではない．


# 自己相関とコレログラム

自己相関の図示はしてきたが，数値で欲しいときもある

```{r}
#自己相関
acf(seas_log_diff,plot = F, lag.max = 12)

#図示
autoplot(
  acf(seas_log_diff,plot = F),
  main = "対数系列のコレログラム"
)
```


```{r}
#編相関係数
pacf(seas_log_diff,plot = F, lag.max = 12)

#図示
autoplot(
  pacf(seas_log_diff,plot = F),
  main = "対数系列のコレログラム"
)
```
  

# 訓練データとテストデータに分ける

予測のために，訓練データとテストデータに分割する


まずは対数変換したグラフを作る


```{r}
Seatbelts_log <- Seatbelts[,c("front", "PetrolPrice", "law")]

Seatbelts_log[,"front"] <- log(Seatbelts[,"front"])

Seatbelts_log[,"PetrolPrice"] <- log(Seatbelts[,"PetrolPrice"])
```

最後の一年をテストデータとする

```{r}
train <- window(Seatbelts_log,end = c(1983,12))

test <- window(Seatbelts_log,start = c(1984,1))
```



今回のモデルではfrontが予測対象であり，応答変数である．
```{r}
#説明変数だけを切り出す
petro_law <- train[,c("PetrolPrice","law")]
```


# ARIMAモデルの推定

```{r}
model_sarimax <- Arima(
  y = train[,"front"],
  order = c(1,1,1),                     #(p,d,q)
  seasonal = list(order = c(1,0,0)),    #(P,D,Q)
  xreg = petro_law
)

model_sarimax
```

# 補足

## 差分系列とARIMAの次数の関係

平易にするために，定数項は入れない

- 差分系列とARIMAの字数を確認する

```{r}
Arima(
  y = log_diff, order = c(1, 0, 0),
  include.mean = F
)
```


この結果は実質アリマ(1,1,0)であることを確認する

```{r}
Arima(
  y = log_front, order = c(1, 1, 0),
  
  include.mean = F        #定数項なし
)
```

- SARIMAと季節階差の関係を確認する

対数差分系列に季節階差を導入したデータにARIMA(1,0,0)を適応する

```{r}
Arima(
  y = seas_log_diff,order = c(1,0,0),
  
  include.mean = F          #定数項なし
)
```


これは実質SARIMA(1,1,0)(0,1,0)であることを確認する

```{r}
Arima(
  y = log_front,order = c(1,1,0),
  seasonal = list(order = c(0,1,0))
)
```



























